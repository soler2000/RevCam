<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Surveillance timeline · RevCam</title>
    <style>
      :root {
        color-scheme: dark light;
        --background: #0f111a;
        --foreground: #f5f7ff;
        --muted: #a2acc8;
        --accent: #4aa8ff;
        --accent-strong: #1d7ef0;
        --card-bg: rgba(18, 22, 33, 0.92);
        --card-border: rgba(255, 255, 255, 0.08);
        --danger: #ff4d61;
        --warning: #f3c95c;
        --success: #38d996;
        --font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      }

      body {
        margin: 0;
        font-family: var(--font-family);
        min-height: 100vh;
        background: radial-gradient(circle at 15% 10%, rgba(74, 168, 255, 0.18), transparent 55%),
          radial-gradient(circle at 85% 15%, rgba(56, 217, 150, 0.12), transparent 60%),
          var(--background);
        color: var(--foreground);
      }

      a {
        color: var(--accent);
      }

      header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(12, 16, 24, 0.85);
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 1.5rem clamp(1rem, 3vw, 2.5rem);
      }

      header .title {
        margin: 0;
        font-size: clamp(1.9rem, 3vw, 2.6rem);
        letter-spacing: -0.03em;
      }

      header nav {
        margin-top: 0.6rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      header nav a {
        text-decoration: none;
        border-radius: 999px;
        padding: 0.45rem 0.9rem;
        color: var(--foreground);
        background: rgba(255, 255, 255, 0.06);
        font-size: 0.9rem;
      }

      header nav a:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      main {
        max-width: 1180px;
        margin: 2.5rem auto 4rem;
        padding: 0 clamp(1rem, 3vw, 2.5rem);
        display: grid;
        gap: 1.5rem;
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        padding: clamp(1.4rem, 3vw, 2rem);
        box-shadow: 0 25px 55px rgba(0, 0, 0, 0.35);
      }

      .filters {
        display: grid;
        gap: 1.2rem;
      }

      .filters .row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .filters label {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        font-size: 0.9rem;
      }

      input[type="search"],
      select {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 12px;
        padding: 0.65rem 0.75rem;
        font: inherit;
        color: var(--foreground);
        min-width: 220px;
      }

      input[type="search"]:focus,
      select:focus {
        outline: 2px solid rgba(74, 168, 255, 0.5);
        outline-offset: 2px;
      }

      .filters button {
        border: 0;
        border-radius: 12px;
        padding: 0.65rem 1.2rem;
        font: inherit;
        background: rgba(255, 255, 255, 0.1);
        color: var(--foreground);
        cursor: pointer;
      }

      .filters button:hover {
        background: rgba(255, 255, 255, 0.18);
      }

      .status-line {
        font-size: 0.9rem;
        color: var(--muted);
        display: flex;
        gap: 1rem;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .status-line .status-message {
        color: var(--muted);
      }

      .status-line .status-message.is-error {
        color: var(--danger);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.12em;
        color: var(--muted);
      }

      th,
      td {
        padding: 0.7rem 0.5rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        vertical-align: middle;
      }

      tbody tr:hover {
        background: rgba(255, 255, 255, 0.06);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.55rem;
        border-radius: 999px;
        font-size: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        color: var(--muted);
      }

      .badge.motion {
        background: rgba(243, 201, 92, 0.15);
        color: var(--warning);
      }

      .badge.processing {
        background: rgba(74, 168, 255, 0.18);
        color: var(--accent);
      }

      .badge.error {
        background: rgba(255, 77, 97, 0.18);
        color: var(--danger);
      }

      .table-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--muted);
      }

      .actions {
        display: inline-flex;
        gap: 0.45rem;
        flex-wrap: wrap;
      }

      .actions a,
      .actions button {
        border: 0;
        border-radius: 8px;
        padding: 0.35rem 0.6rem;
        font-size: 0.8rem;
        color: var(--foreground);
        background: rgba(255, 255, 255, 0.1);
        text-decoration: none;
        cursor: pointer;
      }

      .actions button:hover,
      .actions a:hover {
        background: rgba(255, 255, 255, 0.18);
      }

      footer {
        max-width: 1180px;
        margin: 1.5rem auto 3rem;
        padding: 0 clamp(1rem, 3vw, 2.5rem);
        display: flex;
        justify-content: space-between;
        color: var(--muted);
        font-size: 0.85rem;
      }

      @media (max-width: 820px) {
        th:nth-child(4),
        td:nth-child(4),
        th:nth-child(5),
        td:nth-child(5) {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1 class="title">Surveillance timeline</h1>
      <nav>
        <a href="/surveillance">Dashboard</a>
        <a href="/surveillance/settings">Settings</a>
        <a href="/">Live view</a>
      </nav>
    </header>
    <main>
      <section class="card filters">
        <div class="row">
          <label>
            <span>Search recordings</span>
            <input type="search" id="search-input" placeholder="Search by name or notes" />
          </label>
          <label>
            <span>Filter</span>
            <select id="filter-select">
              <option value="all">All recordings</option>
              <option value="continuous">Continuous only</option>
              <option value="motion">Motion-triggered</option>
              <option value="processing">Processing</option>
              <option value="errors">With errors</option>
            </select>
          </label>
          <button type="button" id="refresh-button">Refresh</button>
        </div>
        <div class="status-line">
          <span id="status-message" class="status-message">Loading timeline…</span>
          <span id="result-count"></span>
        </div>
      </section>

      <section class="card">
        <div class="table-wrapper">
          <table id="recordings-table">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Started</th>
                <th scope="col">Duration</th>
                <th scope="col">Size</th>
                <th scope="col">Mode</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="recordings-body"></tbody>
          </table>
          <div class="table-empty" id="table-empty" hidden>No recordings available yet.</div>
        </div>
      </section>
    </main>
    <footer>
      <span>Clips rotate automatically when size or time limits are reached.</span>
      <span id="updated-at">Updated —</span>
    </footer>

    <script>
      const searchInput = document.getElementById("search-input");
      const filterSelect = document.getElementById("filter-select");
      const refreshButton = document.getElementById("refresh-button");
      const statusMessage = document.getElementById("status-message");
      const resultCount = document.getElementById("result-count");
      const tableBody = document.getElementById("recordings-body");
      const tableEmpty = document.getElementById("table-empty");
      const updatedAt = document.getElementById("updated-at");

      let allRecordings = [];
      let loading = false;

      function formatBytes(value) {
        if (!Number.isFinite(value) || value <= 0) {
          return "—";
        }
        const units = ["B", "KB", "MB", "GB", "TB"];
        const exponent = Math.min(units.length - 1, Math.floor(Math.log(value) / Math.log(1024)));
        const num = value / Math.pow(1024, exponent);
        return `${num.toFixed(num >= 10 ? 0 : 1)} ${units[exponent]}`;
      }

      function formatDuration(seconds) {
        if (!Number.isFinite(seconds) || seconds <= 0) {
          return "—";
        }
        if (seconds < 60) {
          return `${seconds.toFixed(seconds < 10 ? 1 : 0)}s`;
        }
        const minutes = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        if (minutes < 60) {
          return `${minutes}m ${secs.toString().padStart(2, "0")}s`;
        }
        const hours = Math.floor(minutes / 60);
        const remMinutes = minutes % 60;
        return `${hours}h ${remMinutes}m`;
      }

      function formatDateTime(value) {
        if (!value) {
          return "—";
        }
        const date = typeof value === "string" ? new Date(value) : value;
        if (Number.isNaN(date.getTime())) {
          return "—";
        }
        return date.toLocaleString();
      }

      function getMode(record) {
        const info = record?.motion_detection;
        if (record?.processing) {
          return "Processing";
        }
        if (info && (info.session_override === true || info.enabled === true)) {
          return "Motion";
        }
        return "Continuous";
      }

      function getStatusBadge(record) {
        if (record?.processing_error) {
          return '<span class="badge error">Processing failed</span>';
        }
        if (record?.processing) {
          return '<span class="badge processing">Processing</span>';
        }
        if (record?.stop_reason === "storage_low") {
          return '<span class="badge error">Stopped: storage low</span>';
        }
        return '<span class="badge">Ready</span>';
      }

      function matchesFilter(record, query, filter) {
        const text = `${record.name || ""} ${record.notes || ""}`.toLowerCase();
        if (query && !text.includes(query)) {
          return false;
        }
        if (filter === "continuous") {
          return getMode(record) === "Continuous";
        }
        if (filter === "motion") {
          return getMode(record) === "Motion";
        }
        if (filter === "processing") {
          return Boolean(record.processing);
        }
        if (filter === "errors") {
          return Boolean(record.processing_error);
        }
        return true;
      }

      function renderTable() {
        const query = searchInput.value.trim().toLowerCase();
        const filter = filterSelect.value;
        const filtered = allRecordings.filter((record) => matchesFilter(record, query, filter));
        tableBody.innerHTML = "";
        if (filtered.length === 0) {
          tableEmpty.hidden = false;
          resultCount.textContent = "No recordings match the current filters.";
        } else {
          tableEmpty.hidden = true;
          filtered.forEach((record) => {
            const row = document.createElement("tr");
            const mode = getMode(record);
            const status = getStatusBadge(record);
            row.innerHTML = `
              <td>${record.name || "Recording"}</td>
              <td>${formatDateTime(record.started_at || record.startedAt)}</td>
              <td>${formatDuration(record.duration_seconds ?? record.durationSeconds)}</td>
              <td>${formatBytes(record.size_bytes ?? record.sizeBytes)}</td>
              <td>${mode}</td>
              <td>${status}</td>
              <td class="actions"></td>
            `;
            const actions = row.lastElementChild;
            if (record.processing) {
              actions.textContent = "Processing…";
            } else {
              const play = document.createElement("a");
              play.href = `/surveillance/player?name=${encodeURIComponent(record.name)}`;
              play.textContent = "View";
              actions.appendChild(play);

              const download = document.createElement("a");
              download.href = `/api/surveillance/recordings/${encodeURIComponent(record.name)}/download`;
              download.textContent = "Download";
              download.setAttribute("download", "");
              actions.appendChild(download);

              const del = document.createElement("button");
              del.type = "button";
              del.textContent = "Delete";
              del.addEventListener("click", () => deleteRecording(record.name));
              actions.appendChild(del);
            }
            tableBody.appendChild(row);
          });
          resultCount.textContent = `${filtered.length} recording${filtered.length === 1 ? "" : "s"}`;
        }
      }

      function setStatus(message, tone = "info") {
        statusMessage.textContent = message;
        statusMessage.classList.toggle("is-error", tone === "error");
      }

      async function deleteRecording(name) {
        if (!name) {
          return;
        }
        const confirmed = window.confirm(`Delete recording ${name}?`);
        if (!confirmed) {
          return;
        }
        try {
          await fetch(`/api/surveillance/recordings/${encodeURIComponent(name)}`, {
            method: "DELETE",
          });
          await loadRecordings(false);
        } catch (error) {
          console.error("Failed to delete recording", error);
          setStatus("Unable to delete recording", "error");
        }
      }

      async function loadRecordings(showStatus = true) {
        if (loading) {
          return;
        }
        loading = true;
        if (showStatus) {
          setStatus("Loading timeline…");
        }
        try {
          const response = await fetch("/api/surveillance/recordings", { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`Request failed (${response.status})`);
          }
          const payload = await response.json();
          allRecordings = Array.isArray(payload?.recordings) ? payload.recordings : [];
          renderTable();
          const timestamp = new Date();
          updatedAt.textContent = `Updated ${timestamp.toLocaleTimeString()}`;
          setStatus(`Loaded ${allRecordings.length} recording${allRecordings.length === 1 ? "" : "s"}.`);
        } catch (error) {
          console.error("Failed to load surveillance recordings", error);
          allRecordings = [];
          renderTable();
          setStatus(error.message || "Unable to load recordings", "error");
        } finally {
          loading = false;
        }
      }

      searchInput.addEventListener("input", () => renderTable());
      filterSelect.addEventListener("change", () => renderTable());
      refreshButton.addEventListener("click", () => loadRecordings());

      loadRecordings();
    </script>
  </body>
</html>
