<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Surveillance Recording Playback</title>
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg" />
    <style>
      :root {
        color-scheme: dark;
        --font-family: "Inter", "Manrope", "Segoe UI", system-ui, -apple-system,
          BlinkMacSystemFont, sans-serif;
        --surface-0: rgba(14, 16, 22, 0.9);
        --surface-1: rgba(26, 28, 36, 0.85);
        --border-subtle: rgba(255, 255, 255, 0.12);
        --text-primary: #f5f7fb;
        --text-muted: rgba(245, 247, 250, 0.7);
        --accent: #0a84ff;
        --accent-soft: rgba(10, 132, 255, 0.18);
        --danger: #ff453a;
        --radius-lg: 1.2rem;
        --radius-sm: 0.75rem;
        --space-md: 1rem;
        --space-lg: 1.6rem;
        --page-gradient: radial-gradient(
          120% 140% at top,
          #1b1e26 0%,
          #0b0d13 60%,
          #050609 100%
        );
      }
      body {
        margin: 0;
        background: var(--page-gradient);
        font-family: var(--font-family);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
      }
      .player-card {
        width: min(960px, 100%);
        background: var(--surface-1);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-subtle);
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.45);
        padding: var(--space-lg);
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
      }
      header {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      .muted {
        color: var(--text-muted);
      }
      .playback-frame {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 0.9rem;
        border: 1px solid var(--border-subtle);
        background: #000;
      }
      .meta-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        color: var(--text-muted);
        font-size: 0.95rem;
      }
      .meta-pill {
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-subtle);
      }
      .status {
        min-height: 1.25rem;
      }
      .status.error {
        color: var(--danger);
        font-weight: 600;
      }
      .video-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .playback-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }
      .playback-progress {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .playback-progress .progress-time {
        width: 3.25rem;
        text-align: center;
        font-variant-numeric: tabular-nums;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      #playback-progress {
        flex: 1;
        -webkit-appearance: none;
        appearance: none;
        height: 0.4rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.12);
        outline: none;
      }
      #playback-progress:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      #playback-progress::-webkit-slider-runnable-track {
        height: 0.4rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.12);
      }
      #playback-progress::-moz-range-track {
        height: 0.4rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.12);
      }
      #playback-progress::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 0.9rem;
        height: 0.9rem;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.3);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      #playback-progress::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.2);
      }
      #playback-progress::-moz-range-thumb {
        width: 0.9rem;
        height: 0.9rem;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.3);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      #playback-progress::-moz-range-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.2);
      }
      #toggle-playback {
        min-width: 6.5rem;
        font-weight: 600;
      }
      #playback-mode {
        flex: 1;
        text-align: right;
        font-size: 0.9rem;
      }
      button,
      a.link {
        font: inherit;
        border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-primary);
        padding: 0.45rem 0.85rem;
        border-radius: 999px;
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease;
        text-decoration: none;
      }
      button:hover,
      button:focus-visible,
      a.link:hover,
      a.link:focus-visible {
        background: var(--accent-soft);
        border-color: rgba(10, 132, 255, 0.55);
        outline: none;
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.55;
      }
      .footer-links {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="player-card" role="document">
      <header>
        <h1 id="recording-title">Loading recording…</h1>
        <div class="meta-list" id="recording-meta"></div>
        <p id="status-text" class="status muted">Preparing playback…</p>
      </header>
      <video
        id="playback-video"
        class="playback-frame"
        controls
        preload="metadata"
        hidden
      >
        <source id="playback-source" />
        <p>Your browser does not support HTML5 video playback.</p>
      </video>
      <div class="video-actions" id="video-actions" hidden>
        <div class="playback-toolbar">
          <button type="button" id="toggle-playback" aria-label="Toggle playback">
            ⏯
          </button>
          <span id="playback-mode" class="muted"></span>
        </div>
        <div class="playback-progress" id="progress-container" hidden>
          <span class="progress-time" id="progress-current">0:00</span>
          <input
            type="range"
            id="playback-progress"
            min="0"
            max="0"
            step="0.01"
            value="0"
            aria-label="Seek within the recording"
          />
          <span class="progress-time" id="progress-total">0:00</span>
        </div>
      </div>
      <div class="footer-links muted">
        <button type="button" id="save-to-desktop">Save to Desktop</button>
        <span aria-hidden="true">·</span>
        <a class="link" id="download-link" href="#" download>Download recording</a>
        <span aria-hidden="true">·</span>
        <a class="link" href="/surveillance">Back to surveillance</a>
      </div>
    </div>
    <script>
      const params = new URLSearchParams(window.location.search);
      const recordingName = params.get("name");
      const title = document.getElementById("recording-title");
      const metaList = document.getElementById("recording-meta");
      const statusText = document.getElementById("status-text");
      const video = document.getElementById("playback-video");
      const source = document.getElementById("playback-source");
      const actions = document.getElementById("video-actions");
      const toggleButton = document.getElementById("toggle-playback");
      const playbackMode = document.getElementById("playback-mode");
      const progressContainer = document.getElementById("progress-container");
      const progressSlider = document.getElementById("playback-progress");
      const progressCurrent = document.getElementById("progress-current");
      const progressTotal = document.getElementById("progress-total");
      const downloadLink = document.getElementById("download-link");
      const desktopButton = document.getElementById("save-to-desktop");

      let recordingMetadata = null;
      let isScrubbing = false;

      function setStatus(message, kind = "info") {
        if (!statusText) return;
        statusText.textContent = message;
        if (kind === "error") {
          statusText.classList.add("error");
          statusText.classList.remove("muted");
        } else {
          statusText.classList.remove("error");
          statusText.classList.add("muted");
        }
      }

      function formatDuration(seconds) {
        if (typeof seconds !== "number" || !Number.isFinite(seconds) || seconds <= 0) {
          return "0s";
        }
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        const parts = [];
        if (hours) parts.push(`${hours}h`);
        if (minutes) parts.push(`${minutes}m`);
        if (secs || !parts.length) parts.push(`${secs}s`);
        return parts.join(" ");
      }

      function formatBytes(bytes) {
        if (typeof bytes !== "number" || !Number.isFinite(bytes) || bytes <= 0) {
          return "0 B";
        }
        const units = ["B", "KB", "MB", "GB", "TB"];
        let value = bytes;
        let unit = 0;
        while (value >= 1024 && unit < units.length - 1) {
          value /= 1024;
          unit += 1;
        }
        const precision = value >= 10 || unit === 0 ? 0 : 1;
        return `${value.toFixed(precision)} ${units[unit]}`;
      }

      const RESOLUTION_PATTERN = /^(\d+)\s*[x×]\s*(\d+)$/i;

      function normaliseDimension(value) {
        if (typeof value === "number") {
          if (!Number.isFinite(value) || value <= 0) {
            return null;
          }
          return Math.round(value);
        }
        if (typeof value === "string") {
          const trimmed = value.trim();
          if (!trimmed) {
            return null;
          }
          const numeric = Number(trimmed);
          if (!Number.isFinite(numeric) || numeric <= 0) {
            return null;
          }
          return Math.round(numeric);
        }
        return null;
      }

      function parseResolutionValue(value) {
        if (!value) {
          return null;
        }
        if (Array.isArray(value) && value.length >= 2) {
          const width = normaliseDimension(value[0]);
          const height = normaliseDimension(value[1]);
          if (width && height) {
            return { width, height };
          }
        }
        if (typeof value === "object") {
          const width = normaliseDimension(value.width ?? value.w);
          const height = normaliseDimension(value.height ?? value.h);
          if (width && height) {
            return { width, height };
          }
          if ("resolution" in value) {
            return parseResolutionValue(value.resolution);
          }
        }
        if (typeof value === "string") {
          const match = value.trim().match(RESOLUTION_PATTERN);
          if (match) {
            const width = normaliseDimension(match[1]);
            const height = normaliseDimension(match[2]);
            if (width && height) {
              return { width, height };
            }
          }
        }
        return null;
      }

      function resolveRecordingResolution(recording) {
        if (!recording || typeof recording !== "object") {
          return null;
        }
        const direct = parseResolutionValue(recording.resolution);
        if (direct) {
          return direct;
        }
        const fallback = parseResolutionValue({
          width: recording.width,
          height: recording.height,
        });
        if (fallback) {
          return fallback;
        }
        return null;
      }

      function formatClock(seconds, includeFraction = false) {
        if (typeof seconds !== "number" || !Number.isFinite(seconds) || seconds < 0) {
          return "0:00";
        }
        const whole = Math.floor(seconds);
        const fraction = includeFraction ? Math.floor((seconds - whole) * 10) : 0;
        const hours = Math.floor(whole / 3600);
        const minutes = Math.floor((whole % 3600) / 60);
        const secs = whole % 60;
        const pad = (value) => value.toString().padStart(2, "0");
        let base = `${minutes}:${pad(secs)}`;
        if (hours > 0) {
          base = `${hours}:${pad(minutes)}:${pad(secs)}`;
        }
        return fraction > 0 ? `${base}.${fraction}` : base;
      }

      function updateMetadataDisplay(recording) {
        if (!metaList) return;
        metaList.innerHTML = "";
        const items = [];
        if (typeof recording.duration_seconds === "number") {
          items.push(`Duration ${formatDuration(recording.duration_seconds)}`);
        }
        if (typeof recording.size_bytes === "number") {
          items.push(formatBytes(recording.size_bytes));
        }
        const resolution = resolveRecordingResolution(recording);
        if (resolution) {
          items.push(`${resolution.width}×${resolution.height}`);
        }
        if (recording.video_codec) {
          items.push(String(recording.video_codec).toUpperCase());
        }
        if (recording.fps) {
          items.push(`${recording.fps} fps`);
        }
        if (recording.frame_count) {
          items.push(`${recording.frame_count} frames`);
        }
        items.forEach((text) => {
          const span = document.createElement("span");
          span.className = "meta-pill";
          span.textContent = text;
          metaList.appendChild(span);
        });
      }

      function updateProgressUI(durationSeconds) {
        if (!progressContainer || !progressSlider || !progressCurrent || !progressTotal) {
          return;
        }
        const duration = Number.isFinite(durationSeconds) && durationSeconds > 0 ? durationSeconds : 0;
        progressContainer.hidden = false;
        progressSlider.disabled = duration <= 0;
        progressSlider.max = duration > 0 ? String(duration) : "0";
        progressSlider.value = "0";
        progressCurrent.textContent = "0:00";
        progressTotal.textContent = duration > 0 ? formatClock(duration) : "0:00";
      }

      function updateToggleState() {
        if (!toggleButton || !video) return;
        const paused = video.paused || video.ended;
        toggleButton.textContent = paused ? "▶︎ Play" : "⏸ Pause";
        toggleButton.disabled = video.readyState < 2;
      }

      function attachVideoListeners() {
        if (!video) return;
        video.addEventListener("loadedmetadata", () => {
          const duration = Number(video.duration);
          updateProgressUI(Number.isFinite(duration) ? duration : (recordingMetadata?.duration_seconds ?? 0));
          updateToggleState();
          setStatus("Ready to play.");
        });
        video.addEventListener("timeupdate", () => {
          if (!progressSlider || isScrubbing) return;
          const time = Number(video.currentTime);
          if (Number.isFinite(time)) {
            progressSlider.value = String(time);
            if (progressCurrent) {
              progressCurrent.textContent = formatClock(time, true);
            }
          }
        });
        video.addEventListener("play", () => {
          updateToggleState();
          setStatus("Playing");
        });
        video.addEventListener("pause", () => {
          updateToggleState();
          setStatus("Paused");
        });
        video.addEventListener("ended", () => {
          updateToggleState();
          setStatus("Playback finished.");
        });
        video.addEventListener("error", () => {
          setStatus("Unable to load recording media", "error");
        });
      }

      function configureVideoSource(recording) {
        if (!video || !source) return;
        const encodedName = encodeURIComponent(recordingName);
        const mediaUrl = `/api/surveillance/recordings/${encodedName}/media?v=${Date.now()}`;
        source.src = mediaUrl;
        const mediaType = typeof recording.media_type === "string" ? recording.media_type : "video/mp4";
        source.type = mediaType;
        if (playbackMode) {
          const codec = recording.video_codec ? String(recording.video_codec).toUpperCase() : "H.264";
          playbackMode.textContent = `${codec} • ${mediaType}`;
        }
        video.hidden = false;
        if (actions) {
          actions.hidden = false;
        }
        video.load();
      }

      function setupControls() {
        if (toggleButton) {
          toggleButton.addEventListener("click", async () => {
            if (!video) return;
            if (video.paused || video.ended) {
              try {
                await video.play();
              } catch (error) {
                setStatus("Unable to start playback", "error");
              }
            } else {
              video.pause();
            }
          });
        }
        if (progressSlider) {
          const stopScrubbing = (commit) => {
            if (!progressSlider || !video) return;
            const value = Number(progressSlider.value);
            if (commit && Number.isFinite(value)) {
              const target = Number(video.duration);
              const clamped = Number.isFinite(target) && target > 0 ? Math.min(Math.max(value, 0), target) : Math.max(value, 0);
              video.currentTime = clamped;
            }
            isScrubbing = false;
          };
          progressSlider.addEventListener("input", () => {
            isScrubbing = true;
            const value = Number(progressSlider.value);
            if (progressCurrent) {
              progressCurrent.textContent = formatClock(value, true);
            }
          });
          progressSlider.addEventListener("change", () => stopScrubbing(true));
          progressSlider.addEventListener("pointerdown", () => {
            isScrubbing = true;
          });
          progressSlider.addEventListener("pointerup", () => stopScrubbing(true));
          progressSlider.addEventListener("blur", () => stopScrubbing(false));
        }
        if (desktopButton) {
          desktopButton.addEventListener("click", async () => {
            if (!recordingName) return;
            desktopButton.disabled = true;
            setStatus("Saving to desktop…");
            try {
              const encodedName = encodeURIComponent(recordingName);
              const response = await fetch(
                `/api/surveillance/recordings/${encodedName}/export`,
                { method: "POST" }
              );
              let payload = null;
              try {
                payload = await response.json();
              } catch (error) {
                payload = null;
              }
              if (!response.ok) {
                const message =
                  (payload && payload.detail) ||
                  `Failed to save recording (${response.status})`;
                throw new Error(message);
              }
              const exportedPath =
                payload && typeof payload.path === "string" ? payload.path : null;
              if (exportedPath) {
                setStatus(`Saved to desktop: ${exportedPath}`);
              } else {
                setStatus("Saved to desktop.");
              }
            } catch (error) {
              console.error(error);
              setStatus("Unable to save to desktop", "error");
            } finally {
              desktopButton.disabled = false;
            }
          });
        }
      }

      async function fetchRecording() {
        if (!recordingName) {
          setStatus("No recording specified", "error");
          return;
        }
        const encodedName = encodeURIComponent(recordingName);
        if (title) {
          title.textContent = recordingName;
        }
        if (downloadLink) {
          downloadLink.href = `/api/surveillance/recordings/${encodedName}/download`;
        }
        setStatus("Loading recording…");
        try {
          const response = await fetch(`/api/surveillance/recordings/${encodedName}`);
          if (!response.ok) {
            throw new Error(`Failed to load recording: ${response.status}`);
          }
          const data = await response.json();
          recordingMetadata = data;
          updateMetadataDisplay(data);
          const duration = Number(data.duration_seconds);
          updateProgressUI(Number.isFinite(duration) ? duration : 0);
          configureVideoSource(data);
          setStatus("Ready to play.");
        } catch (error) {
          console.error(error);
          setStatus("Unable to load recording metadata", "error");
        }
      }

      (function initialise() {
        if (!recordingName) {
          setStatus("No recording specified", "error");
          return;
        }
        setupControls();
        attachVideoListeners();
        fetchRecording();
      })();
    </script>
  </body>
</html>
