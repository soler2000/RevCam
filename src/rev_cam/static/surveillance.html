<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Surveillance dashboard · RevCam</title>
    <style>
      :root {
        color-scheme: dark light;
        --background: #0f111a;
        --foreground: #f5f7ff;
        --muted: #a2acc8;
        --card-bg: rgba(18, 22, 33, 0.9);
        --card-border: rgba(255, 255, 255, 0.08);
        --accent: #4aa8ff;
        --accent-strong: #1d7ef0;
        --danger: #ff4d61;
        --success: #38d996;
        --warning: #f3c95c;
        --font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        font-family: var(--font-family);
        background: radial-gradient(circle at 20% 20%, rgba(74, 168, 255, 0.16), transparent 55%),
          radial-gradient(circle at 80% 10%, rgba(56, 217, 150, 0.15), transparent 60%),
          var(--background);
        min-height: 100vh;
        color: var(--foreground);
      }

      a {
        color: var(--accent);
      }

      .page-header {
        padding: 1.25rem clamp(1rem, 3vw, 2.5rem);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(14px);
        background-color: rgba(15, 17, 26, 0.72);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .page-header__inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .page-title {
        margin: 0;
        font-size: clamp(1.8rem, 3vw, 2.5rem);
        letter-spacing: -0.03em;
      }

      .page-nav {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .page-nav a,
      .page-nav button {
        border: 0;
        background: none;
        color: var(--foreground);
        font: inherit;
        padding: 0.5rem 0.9rem;
        border-radius: 999px;
        cursor: pointer;
        text-decoration: none;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .page-nav a:hover,
      .page-nav button:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      .page-main {
        max-width: 1200px;
        margin: 2rem auto 4rem;
        padding: 0 clamp(1rem, 3vw, 2.5rem);
        display: grid;
        gap: 1.5rem;
      }

      .dashboard-grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        align-items: stretch;
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 18px;
        padding: 1.5rem;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .card header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 1rem;
      }

      .card-title {
        font-size: 1.2rem;
        margin: 0;
        letter-spacing: -0.01em;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.85rem;
        background: rgba(255, 255, 255, 0.08);
        color: var(--muted);
      }

      .badge.is-active {
        background: rgba(56, 217, 150, 0.2);
        color: var(--success);
      }

      .badge.is-idle {
        background: rgba(255, 77, 97, 0.16);
        color: var(--danger);
      }

      .preview-frame {
        position: relative;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.08);
        min-height: 220px;
        display: grid;
        place-items: center;
      }

      .preview-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .preview-overlay {
        position: absolute;
        inset: 0.75rem;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        pointer-events: none;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.85);
      }

      .preview-message {
        margin: 0;
        font-size: 0.95rem;
        color: var(--muted);
      }

      .actions {
        display: grid;
        gap: 0.75rem;
      }

      .actions button {
        border: 0;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font: inherit;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .actions button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .actions .primary {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
        color: #fff;
        box-shadow: 0 12px 30px rgba(29, 126, 240, 0.35);
      }

      .actions .primary:hover:not(:disabled) {
        transform: translateY(-1px);
      }

      .actions .danger {
        background: rgba(255, 77, 97, 0.14);
        color: var(--danger);
      }

      .actions .secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--foreground);
      }

      .status-grid {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .status-item {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .status-item strong {
        font-size: 1.1rem;
        color: var(--foreground);
      }

      .recordings-table {
        width: 100%;
        border-collapse: collapse;
      }

      .recordings-table thead {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
      }

      .recordings-table th,
      .recordings-table td {
        padding: 0.65rem 0.4rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        text-align: left;
        vertical-align: middle;
      }

      .recordings-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.06);
      }

      .recording-actions {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }

      .recording-actions a,
      .recording-actions button {
        border: 0;
        background: rgba(255, 255, 255, 0.08);
        color: var(--foreground);
        padding: 0.4rem 0.6rem;
        border-radius: 8px;
        font-size: 0.8rem;
        cursor: pointer;
        text-decoration: none;
      }

      .recording-actions button:hover,
      .recording-actions a:hover {
        background: rgba(255, 255, 255, 0.18);
      }

      .muted {
        color: var(--muted);
      }

      .status-banner {
        border-radius: 12px;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.08);
        color: var(--muted);
        font-size: 0.9rem;
      }

      .status-banner.is-error {
        color: var(--danger);
        background: rgba(255, 77, 97, 0.1);
      }

      .status-banner.is-success {
        color: var(--success);
        background: rgba(56, 217, 150, 0.12);
      }

      .timeline-link {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        font-size: 0.9rem;
        text-decoration: none;
        color: var(--accent);
      }

      footer {
        margin: 2rem auto 3rem;
        max-width: 1200px;
        padding: 0 clamp(1rem, 3vw, 2.5rem);
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--muted);
        font-size: 0.85rem;
      }

      @media (max-width: 720px) {
        .page-header__inner {
          flex-direction: column;
          align-items: flex-start;
        }

        .preview-frame {
          min-height: 180px;
        }

        .card header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header class="page-header">
      <div class="page-header__inner">
        <h1 class="page-title">Surveillance</h1>
        <nav class="page-nav">
          <a href="/">Live view</a>
          <a href="/surveillance/settings">Settings</a>
          <a href="/surveillance/timeline">Timeline</a>
          <button id="switch-mode" type="button">Switch to live camera</button>
        </nav>
      </div>
    </header>
    <main class="page-main">
      <section class="dashboard-grid">
        <article class="card" id="preview-card">
          <header>
            <h2 class="card-title">Live preview</h2>
            <span class="badge" id="mode-indicator">Loading…</span>
          </header>
          <div class="preview-frame">
            <img id="surveillance-preview" alt="Surveillance preview" hidden />
            <div class="preview-overlay">
              <p class="preview-message" id="preview-message">Preparing surveillance stream…</p>
            </div>
          </div>
          <div class="status-grid">
            <div class="status-item">
              <span class="muted">Recording mode</span>
              <strong id="recording-mode">—</strong>
            </div>
            <div class="status-item">
              <span class="muted">Clip length</span>
              <strong id="clip-length">Unlimited</strong>
            </div>
            <div class="status-item">
              <span class="muted">Max clip size</span>
              <strong id="clip-size">—</strong>
            </div>
            <div class="status-item">
              <span class="muted">Frame rate</span>
              <strong id="frame-rate">—</strong>
            </div>
          </div>
          <div class="actions">
            <button class="primary" type="button" id="start-continuous">Start continuous recording</button>
            <button class="secondary" type="button" id="start-motion">Start motion recording</button>
            <button class="danger" type="button" id="stop-recording">Stop recording</button>
          </div>
          <div class="status-banner" id="status-banner" hidden></div>
        </article>
        <article class="card">
          <header>
            <h2 class="card-title">Storage</h2>
            <span class="badge" id="storage-label">—</span>
          </header>
          <div class="status-grid">
            <div class="status-item">
              <span class="muted">Free space</span>
              <strong id="storage-free">—</strong>
            </div>
            <div class="status-item">
              <span class="muted">Used space</span>
              <strong id="storage-used">—</strong>
            </div>
            <div class="status-item">
              <span class="muted">Capacity</span>
              <strong id="storage-total">—</strong>
            </div>
            <div class="status-item">
              <span class="muted">Auto threshold</span>
              <strong id="storage-threshold">—</strong>
            </div>
          </div>
          <p class="muted">
            Storage health is monitored automatically. Recordings pause when free space
            falls beneath the configured threshold.
          </p>
          <a class="timeline-link" href="/surveillance/timeline">Open full recording timeline →</a>
        </article>
      </section>

      <article class="card">
        <header>
          <h2 class="card-title">Recent recordings</h2>
          <span class="badge" id="recording-count">—</span>
        </header>
        <div class="status-banner" id="processing-banner" hidden></div>
        <div id="recordings-empty" class="muted">No recordings yet. They will appear here as soon as they finish processing.</div>
        <div class="table-wrapper">
          <table class="recordings-table" id="recordings-table" hidden>
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Started</th>
                <th scope="col">Duration</th>
                <th scope="col">Size</th>
                <th scope="col">Mode</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="recordings-body"></tbody>
          </table>
        </div>
      </article>
    </main>
    <footer>
      <span>RevCam surveillance module</span>
      <span id="last-updated">Updated —</span>
    </footer>

    <script>
      const previewImage = document.getElementById("surveillance-preview");
      const previewMessage = document.getElementById("preview-message");
      const modeIndicator = document.getElementById("mode-indicator");
      const recordingMode = document.getElementById("recording-mode");
      const clipLength = document.getElementById("clip-length");
      const clipSize = document.getElementById("clip-size");
      const frameRate = document.getElementById("frame-rate");
      const statusBanner = document.getElementById("status-banner");
      const startContinuousButton = document.getElementById("start-continuous");
      const startMotionButton = document.getElementById("start-motion");
      const stopButton = document.getElementById("stop-recording");
      const switchModeButton = document.getElementById("switch-mode");
      const storageLabel = document.getElementById("storage-label");
      const storageFree = document.getElementById("storage-free");
      const storageUsed = document.getElementById("storage-used");
      const storageTotal = document.getElementById("storage-total");
      const storageThreshold = document.getElementById("storage-threshold");
      const recordingCount = document.getElementById("recording-count");
      const recordingsEmpty = document.getElementById("recordings-empty");
      const recordingsTable = document.getElementById("recordings-table");
      const recordingsBody = document.getElementById("recordings-body");
      const processingBanner = document.getElementById("processing-banner");
      const lastUpdated = document.getElementById("last-updated");

      let refreshTimer = null;
      let lastStatusSnapshot = null;

      function formatBytes(value) {
        if (!Number.isFinite(value) || value < 0) {
          return "—";
        }
        if (value === 0) {
          return "0 B";
        }
        const units = ["B", "KB", "MB", "GB", "TB"];
        const exponent = Math.min(
          units.length - 1,
          Math.floor(Math.log(value) / Math.log(1024))
        );
        const num = value / Math.pow(1024, exponent);
        return `${num.toFixed(num >= 10 || exponent === 0 ? 0 : 1)} ${units[exponent]}`;
      }

      function formatDuration(seconds) {
        if (!Number.isFinite(seconds) || seconds <= 0) {
          return "—";
        }
        if (seconds < 60) {
          return `${seconds.toFixed(seconds < 10 ? 1 : 0)}s`;
        }
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        if (mins < 60) {
          return `${mins}m ${secs.toString().padStart(2, "0")}s`;
        }
        const hours = Math.floor(mins / 60);
        const remMins = mins % 60;
        return `${hours}h ${remMins}m`;
      }

      function formatDateTime(value) {
        if (!value) {
          return "—";
        }
        const date = typeof value === "string" ? new Date(value) : value;
        if (Number.isNaN(date.getTime())) {
          return "—";
        }
        return date.toLocaleString();
      }

      function setStatusBanner(text, tone = "info") {
        if (!text) {
          statusBanner.hidden = true;
          statusBanner.textContent = "";
          statusBanner.classList.remove("is-error", "is-success");
          return;
        }
        statusBanner.hidden = false;
        statusBanner.textContent = text;
        statusBanner.classList.toggle("is-error", tone === "error");
        statusBanner.classList.toggle("is-success", tone === "success");
      }

      function renderPreview(status) {
        const preview = status?.preview;
        const inSurveillance = status?.mode === "surveillance";
        if (preview && preview.endpoint && inSurveillance) {
          const url = `${preview.endpoint}?v=${Date.now()}`;
          if (previewImage.src !== url) {
            previewImage.src = url;
          }
          previewImage.hidden = false;
          previewMessage.textContent = status.recording
            ? "Recording in progress"
            : "Live surveillance preview";
        } else {
          previewImage.hidden = true;
          previewMessage.textContent = inSurveillance
            ? "Preview stream unavailable"
            : "Enable surveillance mode to view the preview.";
        }
      }

      function renderStatus(status) {
        lastStatusSnapshot = status;
        const inSurveillance = status.mode === "surveillance";
        modeIndicator.textContent = inSurveillance ? "Surveillance active" : "Surveillance disabled";
        modeIndicator.classList.toggle("is-active", inSurveillance);
        modeIndicator.classList.toggle("is-idle", !inSurveillance);

        recordingMode.textContent = status.recording
          ? status.recording_mode === "motion"
            ? "Motion triggered"
            : "Continuous"
          : "Idle";

        const durationSeconds = status.settings?.chunk_duration_seconds;
        clipLength.textContent = durationSeconds ? formatDuration(durationSeconds) : "Unlimited";

        const clipLimitBytes = status.settings?.max_clip_bytes ?? status.storage?.max_clip_bytes;
        clipSize.textContent = clipLimitBytes ? formatBytes(clipLimitBytes) : "Unlimited";

        frameRate.textContent = status.settings ? `${status.settings.fps} fps @ ${status.settings.jpeg_quality}` : "—";

        const storage = status.storage ?? {};
        storageFree.textContent = formatBytes(storage.free_bytes);
        storageUsed.textContent = formatBytes(storage.used_bytes);
        storageTotal.textContent = formatBytes(storage.total_bytes);
        const freePercent = Number(storage.free_percent ?? NaN);
        const threshold = Number(storage.threshold_percent ?? NaN);
        storageLabel.textContent = Number.isFinite(freePercent) ? `${freePercent.toFixed(1)}% free` : "—";
        storageLabel.classList.toggle("badge", true);
        if (Number.isFinite(threshold) && Number.isFinite(freePercent) && freePercent <= threshold) {
          storageLabel.classList.add("is-idle");
        } else {
          storageLabel.classList.remove("is-idle");
        }
        storageThreshold.textContent = Number.isFinite(threshold) ? `${threshold.toFixed(1)}%` : "—";

        renderPreview(status);
        renderRecordings(status.recordings || [], status.processing_recording, status.processing);

        const now = new Date();
        lastUpdated.textContent = `Updated ${now.toLocaleTimeString()}`;

        const allowRecordingActions = inSurveillance;
        startContinuousButton.disabled = !allowRecordingActions || status.recording;
        startMotionButton.disabled = !allowRecordingActions || status.recording;
        stopButton.disabled = !allowRecordingActions || !status.recording;
        switchModeButton.disabled = status.mode === "revcam";
      }

      function renderRecordings(records, processingRecord, processingActive) {
        const visibleRecords = [];
        if (processingRecord && processingRecord.name) {
          visibleRecords.push({ ...processingRecord, processing: true });
        }
        if (Array.isArray(records)) {
          for (const item of records.slice(0, 8)) {
            visibleRecords.push(item);
          }
        }
        if (visibleRecords.length === 0) {
          recordingsEmpty.hidden = false;
          recordingsTable.hidden = true;
        } else {
          recordingsEmpty.hidden = true;
          recordingsTable.hidden = false;
        }
        recordingCount.textContent = `${Array.isArray(records) ? records.length : 0} items`;
        recordingsBody.innerHTML = "";
        visibleRecords.forEach((record) => {
          const row = document.createElement("tr");
          const started = formatDateTime(record.started_at || record.startedAt);
          const duration = formatDuration(record.duration_seconds ?? record.durationSeconds);
          const size = formatBytes(record.size_bytes ?? record.sizeBytes);
          const mode = record.motion_detection?.session_override
            ? record.motion_detection.session_override
            : record.motion_detection?.enabled
            ? "Motion"
            : record.mode || "Continuous";
          const statusCell = record.processing
            ? "Processing…"
            : record.processing_error
            ? "Error"
            : mode;

          row.innerHTML = `
            <td>${record.name || "Recording"}</td>
            <td>${started}</td>
            <td>${duration}</td>
            <td>${size}</td>
            <td>${statusCell}</td>
            <td></td>
          `;
          const actionsCell = row.lastElementChild;
          actionsCell.className = "recording-actions";
          if (!record.processing) {
            const playLink = document.createElement("a");
            playLink.href = `/surveillance/player?name=${encodeURIComponent(record.name)}`;
            playLink.textContent = "Play";
            actionsCell.appendChild(playLink);

            const downloadLink = document.createElement("a");
            downloadLink.href = `/api/surveillance/recordings/${encodeURIComponent(record.name)}/download`;
            downloadLink.textContent = "Download";
            downloadLink.setAttribute("download", "");
            actionsCell.appendChild(downloadLink);

            const deleteButton = document.createElement("button");
            deleteButton.type = "button";
            deleteButton.textContent = "Delete";
            deleteButton.addEventListener("click", () => confirmDelete(record.name));
            actionsCell.appendChild(deleteButton);
          } else {
            actionsCell.textContent = "Processing clip…";
          }
          recordingsBody.appendChild(row);
        });

        if (processingActive) {
          processingBanner.hidden = false;
          processingBanner.textContent = "Processing recent recording…";
        } else if (processingRecord && processingRecord.processing_error) {
          processingBanner.hidden = false;
          processingBanner.classList.add("is-error");
          processingBanner.textContent = processingRecord.processing_error;
        } else {
          processingBanner.hidden = true;
          processingBanner.classList.remove("is-error");
          processingBanner.textContent = "";
        }
      }

      async function postJSON(url, payload) {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: payload ? JSON.stringify(payload) : "{}",
        });
        if (!response.ok) {
          let detail = "";
          try {
            const message = await response.json();
            detail = message?.detail || message?.error || "";
          } catch (error) {
            detail = "";
          }
          const error = new Error(detail || `Request failed (${response.status})`);
          error.status = response.status;
          throw error;
        }
        return response.json().catch(() => ({}));
      }

      async function handleStartRecording(motion = false) {
        try {
          setStatusBanner(motion ? "Starting motion recording…" : "Starting recording…");
          const endpoint = motion
            ? "/api/surveillance/recordings/start-motion"
            : "/api/surveillance/recordings/start";
          await postJSON(endpoint);
          setStatusBanner("Recording started", "success");
          await loadStatus();
        } catch (error) {
          console.error("Failed to start recording", error);
          setStatusBanner(error.message || "Unable to start recording", "error");
        }
      }

      async function handleStopRecording() {
        try {
          setStatusBanner("Stopping recording…");
          await postJSON("/api/surveillance/recordings/stop");
          setStatusBanner("Recording stopped", "success");
          await loadStatus();
        } catch (error) {
          console.error("Failed to stop recording", error);
          setStatusBanner(error.message || "Unable to stop recording", "error");
        }
      }

      async function confirmDelete(name) {
        if (!name) {
          return;
        }
        const confirmed = window.confirm(`Delete recording ${name}?`);
        if (!confirmed) {
          return;
        }
        try {
          await fetch(`/api/surveillance/recordings/${encodeURIComponent(name)}`, {
            method: "DELETE",
          });
          await loadStatus();
        } catch (error) {
          console.error("Failed to delete recording", error);
          setStatusBanner("Unable to delete recording", "error");
        }
      }

      async function handleSwitchMode() {
        try {
          switchModeButton.disabled = true;
          await postJSON("/api/surveillance/mode", { mode: "revcam" });
          setStatusBanner("Returning to live camera", "success");
          window.location.href = "/";
        } catch (error) {
          console.error("Failed to switch mode", error);
          setStatusBanner(error.message || "Unable to switch mode", "error");
        } finally {
          switchModeButton.disabled = false;
        }
      }

      async function loadStatus() {
        try {
          const response = await fetch("/api/surveillance/status", { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`Request failed (${response.status})`);
          }
          const payload = await response.json();
          renderStatus(payload);
          setStatusBanner("", "info");
        } catch (error) {
          console.error("Failed to load surveillance status", error);
          setStatusBanner(error.message || "Unable to load surveillance status", "error");
        }
      }

      function scheduleRefresh() {
        if (refreshTimer) {
          clearInterval(refreshTimer);
        }
        refreshTimer = setInterval(() => {
          if (document.visibilityState === "visible") {
            loadStatus();
          }
        }, 5000);
      }

      startContinuousButton.addEventListener("click", () => handleStartRecording(false));
      startMotionButton.addEventListener("click", () => handleStartRecording(true));
      stopButton.addEventListener("click", handleStopRecording);
      switchModeButton.addEventListener("click", handleSwitchMode);

      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          loadStatus();
        }
      });

      loadStatus();
      scheduleRefresh();
    </script>
  </body>
</html>
