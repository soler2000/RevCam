<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Surveillance settings</title>
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg" />
    <style>
      :root {
        color-scheme: dark;
        --font-family: "Inter", "Manrope", "Segoe UI", system-ui, -apple-system,
          BlinkMacSystemFont, sans-serif;
        --surface-0: rgba(14, 16, 22, 0.92);
        --surface-1: rgba(24, 26, 34, 0.88);
        --surface-2: rgba(36, 38, 48, 0.82);
        --border-subtle: rgba(255, 255, 255, 0.14);
        --border-strong: rgba(255, 255, 255, 0.26);
        --text-primary: #f5f7fb;
        --text-muted: rgba(245, 247, 250, 0.72);
        --text-accent: #0a84ff;
        --danger: #ff453a;
        --success: #32d74b;
        --radius-lg: 1.2rem;
        --radius-md: 0.9rem;
        --radius-sm: 0.6rem;
        --space-xs: 0.4rem;
        --space-sm: 0.6rem;
        --space-md: 1rem;
        --space-lg: 1.6rem;
        --space-xl: 2.4rem;
        --line-height: 1.55;
        --shadow-lg: 0 32px 60px rgba(0, 0, 0, 0.5);
        --shadow-md: 0 20px 40px rgba(0, 0, 0, 0.35);
        --page-gradient: radial-gradient(120% 160% at top, #1b1e26 0%, #090b12 60%, #050609 100%);
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: var(--font-family);
        line-height: var(--line-height);
        background: var(--page-gradient);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header,
      footer {
        padding: var(--space-md) var(--space-xl);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-lg);
        background: var(--surface-0);
        border-bottom: 1px solid var(--border-subtle);
        backdrop-filter: blur(18px) saturate(130%);
        -webkit-backdrop-filter: blur(18px) saturate(130%);
        box-shadow: var(--shadow-md);
      }
      footer {
        border-top: 1px solid var(--border-subtle);
        border-bottom: none;
        justify-content: center;
        margin-top: auto;
      }
      main {
        padding: var(--space-xl);
        display: flex;
        justify-content: center;
      }
      .brand-area {
        display: flex;
        align-items: center;
        gap: var(--space-lg);
        flex-wrap: wrap;
      }
      .brand {
        font-size: 1.4rem;
        font-weight: 700;
      }
      .settings-card {
        width: min(960px, 100%);
        background: var(--surface-1);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-subtle);
        padding: var(--space-xl);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        gap: var(--space-lg);
      }
      .settings-card h1 {
        margin: 0;
      }
      .muted {
        color: var(--text-muted);
      }
      form {
        display: flex;
        flex-direction: column;
        gap: var(--space-lg);
      }
      fieldset {
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
      }
      legend {
        padding: 0 var(--space-xs);
        font-weight: 600;
      }
      label.option {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: var(--space-sm);
        align-items: center;
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        transition: background 140ms ease;
      }
      label.option:hover,
      label.option:focus-within {
        background: var(--surface-2);
      }
      label.option strong {
        display: block;
        font-weight: 600;
      }
      label.option span.helper {
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .preset-grid {
        display: grid;
        gap: var(--space-sm);
      }
      .preset-label {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: var(--space-sm);
        align-items: start;
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        border: 1px solid transparent;
        transition: border-color 160ms ease, background 160ms ease;
      }
      .preset-label:hover,
      .preset-label:focus-within {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--border-subtle);
      }
      .preset-label strong {
        display: block;
        font-weight: 600;
      }
      .preset-label span.meta {
        display: block;
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .expert-grid {
        display: grid;
        gap: var(--space-md);
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .expert-control {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .expert-control label {
        font-weight: 600;
      }
      .expert-control input[type="number"] {
        padding: var(--space-sm);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-subtle);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text-primary);
        font-size: 1rem;
      }
      .summary {
        padding: var(--space-md);
        border-radius: var(--radius-md);
        background: rgba(10, 132, 255, 0.16);
        border: 1px solid rgba(10, 132, 255, 0.4);
        font-weight: 600;
      }
      button[type="submit"] {
        align-self: flex-start;
        padding: 0.75rem 1.8rem;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #0a84ff, #54d1ff);
        color: #041026;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 18px 36px rgba(10, 132, 255, 0.35);
        transition: transform 160ms ease, box-shadow 160ms ease;
      }
      button[type="submit"]:hover,
      button[type="submit"]:focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 22px 40px rgba(10, 132, 255, 0.45);
      }
      button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: wait;
      }
      .status {
        min-height: 1.4rem;
      }
      a.link {
        color: var(--text-accent);
        text-decoration: none;
        font-weight: 600;
      }
      a.link:hover,
      a.link:focus-visible {
        text-decoration: underline;
      }
      @media (max-width: 720px) {
        header,
        footer {
          flex-direction: column;
          align-items: stretch;
          text-align: center;
        }
        main {
          padding: var(--space-lg);
        }
        .settings-card {
          padding: var(--space-lg);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand-area">
        <strong class="brand">RevCam</strong>
        <span class="muted">Surveillance mode</span>
      </div>
      <a class="link" href="/surveillance">Back to surveillance</a>
    </header>
    <main>
      <section class="settings-card">
        <header>
          <h1>Surveillance settings</h1>
          <p class="muted">
            Configure recording behaviour for standard deployments or switch to expert
            mode for full control over frame rate and compression.
          </p>
        </header>
        <form id="surveillance-settings-form">
          <fieldset>
            <legend>Configuration mode</legend>
            <label class="option">
              <input type="radio" name="profile" value="standard" />
              <div>
                <strong>Standard presets</strong>
                <span class="helper">Pick from tuned combinations for common setups.</span>
              </div>
            </label>
            <label class="option">
              <input type="radio" name="profile" value="expert" />
              <div>
                <strong>Expert controls</strong>
                <span class="helper">Manually set capture frame rate and JPEG quality.</span>
              </div>
            </label>
          </fieldset>
          <section id="standard-section" aria-live="polite">
            <h2>Standard presets</h2>
            <p class="muted">
              Choose the preset that best reflects your surveillance needs. Presets adjust
              both the capture frame rate and recording compression.
            </p>
            <div class="preset-grid">
              <label class="preset-label">
                <input type="radio" name="preset" value="balanced" />
                <div>
                  <strong>Balanced coverage</strong>
                  <span class="meta">6 fps • JPEG quality 70 — ideal all-round coverage.</span>
                </div>
              </label>
              <label class="preset-label">
                <input type="radio" name="preset" value="detail" />
                <div>
                  <strong>High detail</strong>
                  <span class="meta">9 fps • JPEG quality 85 — more motion clarity indoors.</span>
                </div>
              </label>
              <label class="preset-label">
                <input type="radio" name="preset" value="endurance" />
                <div>
                  <strong>Extended endurance</strong>
                  <span class="meta">4 fps • JPEG quality 60 — longer recordings, smaller files.</span>
                </div>
              </label>
            </div>
          </section>
          <section id="expert-section" hidden>
            <h2>Expert controls</h2>
            <p class="muted">
              Tune capture parameters precisely. Higher frame rates and JPEG quality increase
              detail at the cost of storage and bandwidth.
            </p>
            <div class="expert-grid">
              <div class="expert-control">
                <label for="expert-fps">Frame rate</label>
                <input id="expert-fps" type="number" min="1" max="30" step="1" />
                <span class="muted">Frames captured per second.</span>
              </div>
              <div class="expert-control">
                <label for="expert-quality">JPEG quality</label>
                <input id="expert-quality" type="number" min="30" max="100" step="1" />
                <span class="muted">Higher values increase detail while using more space.</span>
              </div>
            </div>
          </section>
          <div class="summary" id="settings-summary" role="status" aria-live="polite">
            Effective capture: —
          </div>
          <button type="submit">Save surveillance settings</button>
          <p class="muted status" id="settings-status"></p>
        </form>
      </section>
    </main>
    <footer>
      <a class="link" href="/surveillance">Back to surveillance</a>
      <a class="link" href="/">Back to live view</a>
    </footer>
    <script>
      const STANDARD_PRESETS = {
        balanced: {
          label: "Balanced coverage",
          fps: 6,
          jpeg_quality: 70,
        },
        detail: {
          label: "High detail",
          fps: 9,
          jpeg_quality: 85,
        },
        endurance: {
          label: "Extended endurance",
          fps: 4,
          jpeg_quality: 60,
        },
      };

      const form = document.getElementById("surveillance-settings-form");
      const profileInputs = Array.from(form.querySelectorAll('input[name="profile"]'));
      const presetInputs = Array.from(form.querySelectorAll('input[name="preset"]'));
      const standardSection = document.getElementById("standard-section");
      const expertSection = document.getElementById("expert-section");
      const expertFpsInput = document.getElementById("expert-fps");
      const expertQualityInput = document.getElementById("expert-quality");
      const statusText = document.getElementById("settings-status");
      const summary = document.getElementById("settings-summary");

      let currentSettings = null;

      function getSelectedProfile() {
        const selected = profileInputs.find((input) => input.checked);
        return selected ? selected.value : "standard";
      }

      function getSelectedPreset() {
        const selected = presetInputs.find((input) => input.checked);
        return selected ? selected.value : "balanced";
      }

      function setProfile(profile) {
        profileInputs.forEach((input) => {
          input.checked = input.value === profile;
        });
        updateModeVisibility();
      }

      function setPreset(preset) {
        let matched = false;
        presetInputs.forEach((input) => {
          const checked = input.value === preset;
          input.checked = checked;
          if (checked) {
            matched = true;
          }
        });
        if (!matched && presetInputs.length) {
          presetInputs[0].checked = true;
        }
      }

      function updateModeVisibility() {
        const profile = getSelectedProfile();
        const standard = profile === "standard";
        standardSection.hidden = !standard;
        expertSection.hidden = standard;
        summary.dataset.profile = profile;
        updateSummary();
      }

      function resolveEffectiveSettings() {
        const profile = getSelectedProfile();
        if (profile === "standard") {
          const preset = getSelectedPreset();
          const config = STANDARD_PRESETS[preset] || STANDARD_PRESETS.balanced;
          return {
            profile,
            preset,
            fps: config.fps,
            jpeg_quality: config.jpeg_quality,
          };
        }
        const fpsValue = parseInt(expertFpsInput.value, 10);
        const qualityValue = parseInt(expertQualityInput.value, 10);
        return {
          profile,
          preset: getSelectedPreset(),
          fps: Number.isFinite(fpsValue) ? fpsValue : null,
          jpeg_quality: Number.isFinite(qualityValue) ? qualityValue : null,
        };
      }

      function updateSummary() {
        const effective = resolveEffectiveSettings();
        let text = "Effective capture: ";
        if (effective.fps && effective.jpeg_quality) {
          const prefix =
            effective.profile === "standard"
              ? `${STANDARD_PRESETS[effective.preset]?.label || "Preset"}: `
              : "Expert configuration: ";
          text += `${prefix}${effective.fps} fps, JPEG quality ${effective.jpeg_quality}`;
        } else {
          text += "—";
        }
        summary.textContent = text;
      }

      function applySettings(settings) {
        if (!settings || typeof settings !== "object") {
          return;
        }
        currentSettings = settings;
        const profile = settings.profile === "expert" ? "expert" : "standard";
        setProfile(profile);
        setPreset(settings.preset || "balanced");
        expertFpsInput.value = settings.expert_fps ?? settings.fps ?? 6;
        expertQualityInput.value = settings.expert_jpeg_quality ?? settings.jpeg_quality ?? 75;
        updateModeVisibility();
      }

      async function loadSettings() {
        statusText.textContent = "Loading settings…";
        try {
          const response = await fetch("/api/surveillance/settings", { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`Request failed with ${response.status}`);
          }
          const payload = await response.json();
          if (!payload || typeof payload !== "object") {
            throw new Error("Invalid response payload");
          }
          applySettings(payload.settings);
          statusText.textContent = "";
        } catch (error) {
          console.error("Failed to load surveillance settings", error);
          statusText.textContent = "Unable to load surveillance settings.";
        }
      }

      profileInputs.forEach((input) => {
        input.addEventListener("change", () => {
          updateModeVisibility();
        });
      });
      presetInputs.forEach((input) => {
        input.addEventListener("change", () => {
          updateSummary();
        });
      });
      expertFpsInput.addEventListener("input", updateSummary);
      expertQualityInput.addEventListener("input", updateSummary);

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const profile = getSelectedProfile();
        const payload = { profile };
        if (profile === "standard") {
          payload.preset = getSelectedPreset();
        } else {
          const fpsValue = parseInt(expertFpsInput.value, 10);
          const qualityValue = parseInt(expertQualityInput.value, 10);
          if (!Number.isFinite(fpsValue) || fpsValue < 1 || fpsValue > 30) {
            statusText.textContent = "Enter a frame rate between 1 and 30 fps.";
            expertFpsInput.focus();
            return;
          }
          if (!Number.isFinite(qualityValue) || qualityValue < 30 || qualityValue > 100) {
            statusText.textContent = "JPEG quality must be between 30 and 100.";
            expertQualityInput.focus();
            return;
          }
          payload.expert_fps = fpsValue;
          payload.expert_jpeg_quality = qualityValue;
        }
        statusText.textContent = "Saving settings…";
        form.querySelector("button[type='submit']").disabled = true;
        try {
          const response = await fetch("/api/surveillance/settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            const detail = await response.json().catch(() => null);
            const message = detail && detail.detail ? detail.detail : "Unable to save settings.";
            throw new Error(message);
          }
          const result = await response.json();
          applySettings(result.settings);
          statusText.textContent = "Surveillance settings saved.";
          updateSummary();
        } catch (error) {
          console.error("Failed to save surveillance settings", error);
          statusText.textContent =
            error instanceof Error ? error.message : "Unable to save surveillance settings.";
        } finally {
          form.querySelector("button[type='submit']").disabled = false;
        }
      });

      loadSettings();
    </script>
  </body>
</html>
